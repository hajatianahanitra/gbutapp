var crypto = require('crypto');
var rand = require('csprng');
var mongoose = require('mongoose');
var gravatar = require('gravatar');
var mod = require('config/models');
var MongoClient = require('mongodb').MongoClient, assert = require('assert');
var ObjectId = require('mongodb').ObjectId; 
//var url = 'mongodb://mptdn:mptdn@ds027719.mlab.com:27719/parcautobdd';	
var url = 'mongodb://GBUTAPP:GBUTAPP1234@ds259499.mlab.com:59499/gbutapp';	
exports.membres = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("Membre").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.membrestelma = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("Membre").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.membresairtel = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("Membre").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.membresorange = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("Membre").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.listegroupeeb = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("groupeeb").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.listemenage = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("menage").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.listerealisateurrg = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("rg").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.pb = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("pb").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.ebp = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("texte").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.mvf = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("mvf").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.veillee = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("veillee").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.biblio = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("biblio").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.listecellules = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("cellules").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.calendrier = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("programmes").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.listevoituresdisponibles = function(callback) {
	var liste = [];
	var result=[];
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("missions").find({});
		cursor.toArray(function(err, d) {
				for (var i = 0; i < d.length; i++) {
					//console.log(d[i].idVoiture);
			   		liste.push(ObjectId(""+d[i].idVoiture+""));
				}
					console.log("oui"+liste.length);
					/*var li = liste.map(function(o){ return mongoose.Types.ObjectId(o);});
					console.log(li);*/
				console.log(liste);
				var cursor1 = db.collection("voitures").find({_id:  { $nin:  liste} }).toArray(function(err,items){
											callback(items);
							        });
					
				});	
		
	
	});
}
exports.listevoituresenmission = function(callback) {
	var liste = [];
	var result=[];
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("missions").find({});
		cursor.toArray(function(err, d) {
				for (var i = 0; i < d.length; i++) {
					//console.log(d[i].idVoiture);
			   		liste.push(ObjectId(""+d[i].idVoiture+""));
				}
					console.log("oui"+liste.length);
					/*var li = liste.map(function(o){ return mongoose.Types.ObjectId(o);});
					console.log(li);*/
				console.log(liste);
				var cursor1 = db.collection("voitures").find({_id:  { $in:  liste} }).toArray(function(err,items){
											callback(items);
							        });
					
				});	
		
	
	});
}

exports.listevoituresdemissions = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var idtype = db.collection("typevoitures").find( { libelle : "Voiture de mission" });
		idtype.toArray(function(err, docs) {
			console.log(docs[0]._id);
			var cursor = db.collection("voitures").find( { idtypeVoiture : ""+docs[0]._id+"" });
			cursor.toArray(function(err, d) {
				callback(d);
				db.close();
			});
		});
		
	});
}
/*exports.listevoituresdefonctions = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("voitures").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}*/
exports.listevoituresdefonctions = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var idtype = db.collection("typevoitures").find( { libelle : "Voiture de fonction" });
		idtype.toArray(function(err, docs) {
			console.log(docs[0]._id);
			var cursor = db.collection("voitures").find( { idtypeVoiture : ""+docs[0]._id+"" });
			cursor.toArray(function(err, d) {
				callback(d);
				db.close();
			});
		});
		
	});
}
exports.listevoituresdeservices = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var idtype = db.collection("typevoitures").find( { libelle : "Voiture de service" });
		idtype.toArray(function(err, docs) {
			console.log(docs[0]._id);
			var cursor = db.collection("voitures").find( { idtypeVoiture : ""+docs[0]._id+"" });
			cursor.toArray(function(err, d) {
				callback(d);
				db.close();
			});
		});
		
	});
}
exports.listeemployes = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("employes").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listechauffeurs = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("employes").find({fonction:"Chauffeur"});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listedemandes = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("demandes").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listedemandesnonrepondus = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("demandes").find({statut:false});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listedepartements = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("departements").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listetypeutilisateurs = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("typeutilisateurs").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listetypeentretiens = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("typeentretiens").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listemissions = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("missions").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listemissionsaujourdhui = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("missions").find( { dateDebut : {"$lte" : new Date()} , dateFin : {"$gte" : new Date()}   });
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listenotifications = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("demandes").find({statut:false});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.listetypevoitures = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("typevoitures").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.parametre = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("parametres").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.lieu = function(callback) {
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("lieus").find({});
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}

exports.tbdepenses = function(callback) {
	MongoClient.connect(url, function(err, db) {
	var cursor = db.collection("missions").aggregate([
		{
		$lookup:
		{from: "voitures",localField: "idVoiture",foreignField: "_id",as: "info"}
		},
		{ $unwind: "$info" },
		{$group : { "_id": { $month: "$dateDebut"} , somme : {$sum : "$info.consommation" }}
		},
		{ $project : { "_id" : 1 , somme: 1}}
	]);
	cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
});
}
exports.tbconsommation = function(id,callback) {
	MongoClient.connect(url, function(err, db) {
	var cursor = db.collection("missions").aggregate([
		{ $match: { "idVoiture": ObjectId(""+id+"") } },
		{
		$lookup:
		{from: "voitures",localField: "idVoiture",foreignField: "_id",as: "info"}
		},
		{ $unwind: "$info" },
		{$group : { "_id":  {$month: "$dateDebut"}  , somme : {$sum : "$info.consommation" }}
		},
		{ $project : { "_id" : 1 , somme: 1 }}
	]);
	cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
});
}
exports.tbdepensesdetails = function(uid,callback) {
	var id = parseInt(uid);
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("missions").aggregate([
		{
			$lookup: {from: "voitures",localField: "idVoiture",foreignField: "_id",as: "info"}
		},
		{ $unwind: "$info" } ,
		{ $project : { prix: { $month: "$dateDebut" } , dateDebut : 1 , consommation : "$info.consommation" , numero : "$info.numero" , _id: 0 , prixc: "$prixc"  }},
		{ $match: { prix: id } }
	]);
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
exports.tbconsommationdetails = function(id,idvoiture,callback) {
	var idm = parseInt(id);
	MongoClient.connect(url, function(err, db) {
		var cursor = db.collection("missions").aggregate([
		{
			$lookup: {from: "voitures",localField: "idVoiture",foreignField: "_id",as: "info"}
		},
		{ $unwind: "$info" } ,
		{ $project : {  kilometrage: { $month: "$dateDebut" }  , idVoiture : 1 , dateDebut : 1 , consommation : "$info.consommation"}},
		{ $match: { kilometrage: idm , idVoiture : ObjectId(""+idvoiture+"")  } }
	]);
		cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
	});
}
/*
exports.tbconsommation = function(id,callback) {
	MongoClient.connect(url, function(err, db) {
	var cursor = db.collection("missions").aggregate([
		{ $match: { "idVoiture": ObjectId(""+id+"") } },
		{
		$lookup:
		{from: "voitures",localField: "idVoiture",foreignField: "_id",as: "info"}
		},
		{ $unwind: "$info" },
		{$group : { "_id": { month :  {$month: "$dateDebut"} ,  idVoiture : "$idVoiture"}  , somme : {$sum : "$info.consommation" }}
		},
		{ $project : { "_id" : 1 , somme: 1 , idVoiture : 1 }}
	]);
	cursor.toArray(function(err, docs) {
			callback(docs);
			db.close();
		});
});
}*/
//GRAPHE TB DEPENSES
//select mois(datedebut) , sum(consommation) , sum(consommation*prixGazoil*km) from mission m group by Mois

//db.missions.aggregate([{$group : { _id: { $month: "$dateDebut"}, consom : {$sum :"$consommation"}}}])

//ON CLICK
//select datedebut , idvoiture , consommation , sum(consommation*prixGazoil*km)  from mission where mois(datedebut) = 2
//db.missions.find({datedebut , idvoiture , consommation } , { month :{ $month: "$dateDebut" } });

// GRAPHE TB CONSOMMATION
//select mois(datedebut) , sum(consommation) , idVoiture , sum(km) from mission where idVoiture = ?  group by Mois
//db.missions.aggregate([{$group : { _id: idVoiture, mois: { $month: "$dateDebut"}} , consom : {$sum :"$consommation"} ])

//select datedebut , consom , km from mission where idvoiture = ? and mois(dateDebut) = ?


/*
db.missions.aggregate([
{
$lookup:
{from: "voitures",localField: "idVoiture",foreignField: "_id",as: "info"}
},
{ $unwind: "$info" },
{$group : { "_id": { $month: "$dateDebut"} , somme : {$sum : "$info.consommation" }}
},
{ $project : { "_id" : 1 , somme: 1}}
]);



db.missions.aggregate([
{
$lookup:
{from: "voitures",localField: "idVoiture",foreignField: "_id",as: "info"}
},
{ $unwind: "$info" },
{$group : { "_id": { $month: "$dateDebut"} , somme : {$sum : { $multiply: [ "$info.consommation", "$km" ] }  }}
},
{ $project : { "_id" : 1 , somme: 1}}
]);



db.missions.aggregate([
{ $match: { "idVoiture": ObjectId("59969b3b8f1914b6dcd46b6d") } },
{
$lookup:
{from: "voitures",localField: "idVoiture",foreignField: "_id",as: "info"}
},
{ $unwind: "$info" },
{$group : { "_id": { month :  {$month: "$dateDebut"} ,  idVoiture : "$idVoiture"}  , somme : {$sum : "$info.consommation" }}
},
{ $project : { "_id" : 1 , somme: 1 , idVoiture : 1 }}
]);

*/